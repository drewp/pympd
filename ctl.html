<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>MPD control</title>

    <link rel="stylesheet" type="text/css" href="ext-all.css" />
    <link rel="stylesheet" type="text/css" href="ctl.css" />

    <script type="text/javascript" src="MochiKit-r1383.js"></script>
    <script type="text/javascript" src="ext-base.js"></script>
    <script type="text/javascript">
      Ext.BLANK_IMAGE_URL = "images/default/s.gif";
    </script>
    <script type="text/javascript" src="ext-all.js"></script>
    <script type="text/javascript" src="mpd.js"></script>
    <script type="text/javascript" src="priv.js"></script>
    <script type="text/javascript">

    function updateStatus(status) {
        $('status').innerHTML = serializeJSON(status);
	$('state').innerHTML = status.state;
	$('state').setAttribute('class', 'state state-'+status.state);
	// 'error' key should be displayed. to get one, add a bogus http:// path
	updatePlayingRow(status.song);
    }

    /*
    highlight the given row number in the playlist
    */
    function updatePlayingRow(num) {
	var lastPlaying = $('playlist').getAttribute("playingRow");
	if (lastPlaying != null) {
	    try {
		removeElementClass($('playlist').childNodes[lastPlaying], 
				   "playing");
	    } catch(e) {
		// lastplaying row might be deleted already
	    }
	}

	var playingRow = $('playlist').childNodes[num];
	addElementClass(playingRow, "playing");
	$('playlist').setAttribute("playingRow", num);
    }

    /*
    shorten/cleanup filenames for display in the playlist
    */
    function displayedName(filename) {
	var parts = filename.split('/');
	var L = parts.length;
	if (L >= 2) {
	    filename = parts[L - 2] + '/' + parts[L - 1];
	}
	filename = filename.replace(/\.(mp3|ogg)$/, "");
	filename = filename.replace(/_/g, " ");
	return filename;
    }

    function updatePlaylist() {
	callMpd("playlistinfo").addCallback(function (songs) {
	    function songRow(song) {
		var del = A({href:'javascript:delId('+song.Id+')'}, "[X]");
		var link = A({href:'javascript:playPos('+song.Pos+')'}, 
         	    displayedName(song.file));
		return DIV({class:'song row-'+song.Pos}, [del, " ", link]);
	    }

	    var rows = []; //list(applymap(songRow, songs)); errors silently!
	    forEach(songs, function (s) { rows.push(songRow(s)) });

	    if (!rows.length) {
		rows = [DIV({class:'no-songs'}, ["No songs in playlist"])];
	    }

	    replaceChildNodes($('playlist'), rows);
	    var row = $('playlist').getAttribute("playingRow")
	    if (row != null) {
		updatePlayingRow(row);
            }
	});
    }   

    function setupLibraryTree() {
	var loader = new Ext.tree.TreeLoader({dataUrl:'mpd/lsinfoTree'});	

	var selection = new Ext.tree.MultiSelectionModel();
	var tree = new Ext.tree.TreePanel({
            el:'tree-div',
            autoScroll:true,
            animate:true,
            containerScroll: true, 
            loader: loader,
	    selModel: selection,
	    bbar: [{text:"Add", 
		    handler:function(ev){
			chain = succeed();
			forEach(selection.getSelectedNodes(), function (node) {
			    chain.addCallback(function (result) {
				return callMpd("add", {path:node.id});
			    });
			});
		        // busy cursor until they're all done?
			chain.addCallback(function (result) {
			    updatePlaylist();
			});
		    },
		   }],
	});

	var root = new Ext.tree.AsyncTreeNode({
            text: 'Music Library',
            draggable:false,
            id:'/'
	});
	tree.setRootNode(root);

	// oops, this is also trapping attempts to expand albums. those 
	// should probably go back to expand/collapse, not addPlay
	tree.addListener('dblclick', function (node, ev) {
	    addPlay(node.id);
	});
	// how do i bind return-key to the same action?

	tree.render();
	root.expand();
    }

    function addRadio() {
	forEach(stations, function (nameUrl) { 
	    var cmd = "playOne('" + nameUrl[1] + "'); return false;";
	    $('radio').appendChild(INPUT({
		type:"submit", 
		value:nameUrl[0], 
		class:'radio',
		onclick:cmd}));
	});
    }

    function startPolling() {
	Ext.TaskMgr.start({run: function() { callMpd("status") },
			   interval: 5000});
    }

    MochiKit.DOM.addToCallStack(window, 'onload', function () {
	//logMpdCommands('lastCmd');
	observeStatus(updateStatus);
	observePlaylist(updatePlaylist);

	callMpd("status");
	updatePlaylist();
	setupLibraryTree();
	addRadio();
	startPolling();
    });

    </script>
  </head>
  <body>

    <div id="state"></div>

    <div class="buttonBar">
      <form id="buttons">
	<div>
	  <input type="submit" value="playone" 
		 onclick="playOne('05_Ultramarine.mp3'); return false"/>
	  <input type="submit" value="play / pause" 
		 onclick="callMpd('pause', {}, true); return false"/>
	  <input type="submit" value="stop" 
		 onclick="callMpd('stop', {}, true); return false"/>
	  <input type="submit" value="seek :10" 
		 onclick="callMpd('seek', {seconds:10}, true); return false"/>
	  
	</div>
	<div id="radio">
	</div>
      
      </form>
    </div>
    
    <div id="tree-div" 
	 style="float: right;overflow:auto; height:300px;width:250px;"></div>

    <div id="playlist">
    </div>

    <div class="buttonBar">
      <form>
	<input type="submit" value="clear playlist" 
	       onclick="callMpd('clear').addCallback(playlistChanged); return false"/>
      </form>
      
    </div>
    
    <div style="clear:right"/>

    <div class="buttonBar">
      <form>
	  <input type="submit" value="Freshen status" 
		 onclick="callMpd('status'); return false"/>
	  <input type="submit" value="Freshen playlist" 
		 onclick="updatePlaylist(); return false"/>
      </form>
    </div>

    Status:
    <div id="status"></div>

    Commands:
    <div id="lastCmd"></div>

    <div style="display: none">
      todo:
        OK indicate playing song
        OK add any songs
	OK delete song(s)
	OK track current song time and change
	playlistinfo for current song names
        get ACS pods
	seeker
	simpler alternate players, like for treo
	pretty
	delete related adjacent songs
        widget
        keyboard shortcuts on all buttons
    </div>

  </body>
</html>