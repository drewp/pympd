<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>MPD control</title>
    <link rel="stylesheet" type="text/css" href="http://extjs.cachefly.net/ext-2.2/resources/css/ext-all.css" />
    <link rel="stylesheet" type="text/css" href="ctl.css" />
    <script type="text/javascript" src="MochiKit-r1383.js"></script>
    <script type="text/javascript" src="http://extjs.cachefly.net/builds/ext-cdn-428.js"></script>
    <script type="text/javascript">
      Ext.BLANK_IMAGE_URL = "ext-2.2/resources/images/default/s.gif";
    </script>

    <script type="text/javascript" src="mpd.js"></script>
    <script type="text/javascript" src="ext-controls.js"></script>
    <script type="text/javascript" src="priv.js"></script>
    <script type="text/javascript">
      // <![CDATA[
      var player = new mpd.Mpd("");

      var volumeSlider;

    function updateStatus(status) {
        $('status').innerHTML = serializeJSON(status);
	$('state').innerHTML = status.state;
	$('state').setAttribute('class', 'state state-'+status.state);
	// 'error' key should be displayed. to get one, add a bogus http:// path
	updatePlayingRow(status.song);
	updatePlayingSong(status.song);
	volumeSlider.setValue(status.volume);
    }

    /*
    Get new info about the currently-playing song in the playlist. Streaming 
    audio has changing values for Name and Title. If this song isn't streaming 
    audio, it might be pointless to keep fetching its info.
    */
    function updatePlayingSong(song) {
	player.callMpd("playlistinfo", {song: song}).addCallback(function (info) {
	    console.log(info);
	    var addlData = $('song-row-' + info[0].Pos);
	    replaceChildNodes(addlData, [DIV({}, info[0].Title)]);
	    
	});
    }

    /*
    highlight the given row number in the playlist
    */
    function updatePlayingRow(num) {
	var lastPlaying = $('playlist').getAttribute("playingRow");
	if (lastPlaying != null) {
	    try {
		removeElementClass($('playlist').childNodes[lastPlaying], 
				   "playing");
	    } catch(e) {
		// lastplaying row might be deleted already
	    }
	}

	var playingRow = $('playlist').childNodes[num];
	if (playingRow == null) {
	    return;
	}
	addElementClass(playingRow, "playing");
	$('playlist').setAttribute("playingRow", num);
    }

    /*
    shorten/cleanup filenames for display in the playlist
    */
    function displayedName(song) {
	var name = song.file;
	if (song.Name) {
	    // streaming radio puts the stream title here; current 
	    // song is in 'Title'
	    name = song.Name;
	}
	
	var parts = name.split('/');
	var L = parts.length;
	if (L >= 2) {
	    name = parts[L - 2] + '/' + parts[L - 1];
	}
	name = name.replace(/\.(mp3|ogg)$/, "");
	name = name.replace(/_/g, " ");
	return name;
    }

    function updatePlaylist() {
	player.callMpd("playlistinfo").addCallback(function (songs) {
	    function songRow(song) {
		var deleteButton = A({href:'javascript:player.delId('+song.Id+')'}, "[X]");
		var playLink = A({href:'javascript:player.playPos('+song.Pos+')'}, 
         	    displayedName(song));
		var addlData = DIV({id:'song-row-'+song.Pos}, null);
		return DIV({'class': 'song row-'+song.Pos}, 
			   [deleteButton, " ", playLink, addlData]);
	    }

	    var rows = []; //list(applymap(songRow, songs)); errors silently!
	    forEach(songs, function (s) { rows.push(songRow(s)) });

	    if (!rows.length) {
		rows = [DIV({'class': 'no-songs'}, ["No songs in playlist"])];
	    }

	    replaceChildNodes($('playlist'), rows);
	    var row = $('playlist').getAttribute("playingRow")
	    if (row != null) {
		updatePlayingRow(row);
            }
	});
    }   

    function addRadio() {
	forEach(stations, function (nameUrl) { 
	    var cmd = "player.playOne('" + nameUrl[1] + "'); return false;";
	    $('radio').appendChild(INPUT({
		type:"submit", 
		value:nameUrl[0], 
		'class':'radio',
		onclick:cmd}));
	});
    }


    function go() {
	//logMpdCommands('lastCmd');
	volumeSlider = createVolumeSlider($('volume'), player);
	observeStatus(updateStatus);
	observePlaylist(updatePlaylist);

	player.callMpd("status");
	updatePlaylist();
	setupLibraryTree();
	addRadio();
	startPolling(player);
    }

    MochiKit.DOM.addToCallStack(window, 'onload', go);
      // ]]>
    </script>
  </head>
  <body>

    <table style="border: 0">
      <tr>
	<td><div id="state"></div></td>
	<td style="background: white"><div id="volume"></div></td>
	<td>
	  <div class="buttonBar">
	    <input type="submit" value="playone" 
		   onclick="playOne('05_Ultramarine.mp3'); return false"/>
	    <input type="submit" value="play / pause" 
		   onclick="player.callMpd('pause', {}, true); return false"/>
	    <input type="submit" value="stop" 
		   onclick="player.callMpd('stop', {}, true); return false"/>
	    <input type="submit" value="seek :10" 
		   onclick="player.callMpd('seek', {seconds:10}, true); return false"/>
	    <div id="radio">
	    </div>
	  </div>
	</td>
      </tr>
    </table>

    <div id="tree-div" 
	 style="float: right;overflow:auto; height:300px;width:250px;"></div>

    <div id="playlist">
    </div>

    <div class="buttonBar">
      <input type="submit" value="clear playlist" 
	     onclick="player.callMpd('clear').addCallback(playlistChanged); return false"/>	
    </div>
    
    <div style="clear:right"/>


    <div class="buttonBar">
      <input type="submit" value="Freshen status" 
	     onclick="player.callMpd('status'); return false"/>
      <input type="submit" value="Freshen playlist" 
	     onclick="updatePlaylist(); return false"/>
    </div>


    Status:
    <div id="status"></div>

    Commands:
    <div id="lastCmd"></div>

    <div style="display: none">
      todo:
        OK indicate playing song
        OK add any songs
	OK delete song(s)
	OK track current song time and change
	OK playlistinfo for current song names
	OK volume
        OK fix web logs
        OK fix volume ctl url; just serve extjs at toplevel
        OK use ext CDN
        widget
        get the http methods right
	close cvs, update pypi, rename for other proj?
        get ACS pods
	seeker
	simpler alternate players, like for treo
	pretty
	delete related adjacent songs
        keyboard shortcuts on all buttons
    </div>
<a href="">refresh</a>
  </body>
</html>
