<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>MPD control</title>

	<style type="text/css" media="all">
	/* <![CDATA[ */
	body {
	    background: #121212;
	    font-family: sans-serif;
	    color: white;
	}
	h2 {
	    margin: 0;
	    padding: 0;
	}
	#transport {
	    background: #000000;

	}
	.volumeStack {
	    width: 170px;
	    border: 1px solid gray;
	    padding: 5px;
	    position: relative;
	  
	}
	.volumeStack button {
	    width: 70px;
	    height: 30px;
	}
	.volumeStack > div {
	    margin: 5px 0;
	}

	.volumeStack .local { position: absolute; margin: 0; left: 90px; }
	.volumeStack .upper {   top: 90px; }
	.volumeStack .current { top: 120px}
	.volumeStack .lower {   top: 150px; }
	.volumeStack .upper button { background: #caa; }
	.volumeStack .lower button { background: #aca; }
	.volumeStack .current button { }

	#currentPlaylist {
	    padding-left: 22px;
	}

	#playlistButtons button {
	    -moz-border-radius:10px;
	    -webkit-border-radius:10px;
	    border:2px outset gray;
	    padding:15px;
	    width: 105px;
	}
	#pause {
	    padding:10px 50px;
	}
	.currentPandoraSong {
	    color: #F25AD8;
	    border: 1px solid #F25AD8;
	    height: 1.2em;
	}

	.playing {
	    background: #404040;
	}
	.section {
	    border: 1px solid gray;
	    border-radius: 5px;
	    margin: 3px;
	} 

	.transport { width: 200px; }
	#playlists > div {
	    display: inline-block;
	}
	#playlists > div > button {
	    background-color: #4A555E;
	    border-color: #2F2F2F;
	    border-style: outset;
	    border-width: 1px;
	    color: #D4D7ED;
	    height: 29px;
	    margin: 2px;
	    padding: 4px;
	}
	#stations {
	    overflow: hidden;
	}
	#stations > div {
	    display: inline-block;
	}
	#stations > div > button {
	    background-color: #4E4E4E;
	    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAAAQAAAAEABcxq3DAAABwUlEQVQ4y6WTv2tTURTHP+/09PZa/BW0iARUSq3USRA7WMTNQAkK/gOC4OwmCs4VV8FFB+vUzbktSAdBHGyD4GbBoJXakGryeC95XJKrw0teX5su1i93Oofz5fs953uDhy8W//AfUIAn90oHGn70ciklAPi+uYlVg7UGNQZVRUTw3gPgvSdJEpzr4JyjePrUjgKAUWtZXv3G2voWK5UqR0YNU2dOAhC2HLdmJrk5cwFwiOyxALC9/Yvb1y9SujLBSqXK1Nkxnt+fBeD10ieeLrxHgoDy1Uk2NmqcKBQAyLjCKKZer3PssM25DICAO6VLALxd+0qjEdJsxoMKrDG0k4SftRoA3a4nasWICM04AcAMQRRGWKuDBGZEGVLNRHnfpdVKiNqOV8ufAbhx+RxiBMPwIMGwjmBUUU1LX340eDz/DoCJYoH5B7OMHT1Ep+Nwe3MAYIyiarLG+eJx5u5eQwCfVQUVAdnHgvSKqv29Bqmd9OE96flEUfX7K/DeE8apwKi9c2/J30vAqOY05bD4scrcwofeDn7z7M0qlfWtXfFVkZylnAKA8vQ45elx6EW4z54f8OxGRtBP1r9CIf1VB8VffPCPKn6rmkEAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTEtMTEtMDdUMjM6MjY6MzItMDg6MDAhBsS5AAAAJXRFWHRkYXRlOm1vZGlmeQAyMDExLTExLTAzVDEwOjExOjMyLTA3OjAwZpwUuQAAAABJRU5ErkJggg==");
	    background-position: 5px 5px;
	    background-repeat: no-repeat;
	    border-color: #2F2F2F;
	    border-style: outset;
	    border-width: 1px;
	    color: #FFFFFF;
	    height: 29px;
	    margin: 2px;
	    padding: 4px 4px 4px 24px;
	    white-space: nowrap;
	    overflow: hidden;
	}

	.loadPlaylistArea, .loadStationArea {
	    float:left;
	    width: 45%;
	}

        .section.search {
            position: relative;
        }
        .results {
            background: none repeat scroll 0 0 #333333;
            border: 2px solid white;
            box-shadow: 0 10px 20px #000000;
            display: inline-block;
            left: 4em;
            padding: 5px;
            position: absolute;
            top: 100%;
            z-index: 5;
        }

	/* ]]> */
	 </style>

    <script type="text/javascript" src="static/jquery-1.6.4.min.js"></script>
    <script type="text/javascript" src="static/underscore-1.2.0.min.js"></script> 
    <script type="text/javascript" src="static/backbone-0.5.3.min.js"></script> 
    <script type="text/javascript" src="static/jquery.form.js"></script> 
    <script type="text/javascript">
    // <![CDATA[
    $(function () {
	

	function albumFromSongFile(f) {
	    return f.replace(/\/[^/]+$/, "");
    }
      function strip(s) {
	  return s.replace(/^\s+/,"").replace(/\s+$/, "");
      }
      
      
      function mpdAjax(method, url, dataObj, success) {
	  return $.ajax({
	      type: method,
	      url: url,
	      data: JSON.stringify(dataObj),
	      headers: {"content-type" : "application/json"},
	      success: success
	  });
      }

	  var mpfResource = {root: "mpdpandorafeeder/",
			     stations: "mpdpandorafeeder/stations/",
			     currentSong: "mpdpandorafeeder/currentSong",
			     currentStation: "mpdpandorafeeder/currentStation"};

	  {
	      var volume = new (Backbone.Model.extend({
		  url: "mpd/status",
		  parse: function (response) {
		      return {volume: response.volume};
		  },
		  save: function (attrs, options) {
		      options || (options = {});
		      if (attrs && !this.set(attrs, options)) return false;
		      var model = this;
		      var success = options.success;
		      options.success = function(resp, status, xhr) {
			  if (!model.set(model.parse(resp, xhr), options)) return false;
			  if (success) success(model, resp, xhr);
		      };
		      options.error = wrapError(options.error, model, options);
		      var method = this.isNew() ? 'create' : 'update';
		      return mpdAjax("post", this.url, model.toJSON(), 
				     function () {});
		  }
	      }));

	      var incr = 3;
	      var volumeView = new (Backbone.View.extend({
		  el: $(".volumeStack"),
		  model: volume,
		  events: { 
		      "click button": "button",
		  },
		  initialize: function () {
		      this.model.bind('change', function (vol) {
			  this.render();
		      }, this);
		  },
		  render: function () {
		      var v = this.model.get("volume")
		      this.$(".current").text(v);
		      this.$(".upper button").text(Math.min(100, v+incr));
		      this.$(".lower button").text(Math.max(0, v-incr));
		  },
		  button: function (ev, a, b) {
		      mpdAjax("put", "mpd/setvol", 
			      {vol: parseInt($(ev.target).text())},
			      function () { updateStatus(); });
		  }
	      }));
	  }

	  {
	      window.Playlist = Backbone.Model.extend({});
	      
	      var playlists = new (Backbone.Collection.extend({
		  model: Playlist,
		  url: "mpd/playlists",
		  parse: function (response) {
		      return response.playlists;
		  }
	      }));

	      playlists.bind('reset', function() {
		  $("#playlists").empty();
		  playlists.each(function(pl) {
		      var view = new PlaylistView({model: pl});
		      $("#playlists").append(view.render().el);
		  });
	      }, this);
	      playlists.fetch();

	      window.PlaylistView = Backbone.View.extend({
		  tagName: "div",
		  events : {
		      "click" : "loadPlaylist"
		  },
		  render: function () { 
		      var div = $("<button>").addClass("playlist").text(
			  this.model.get("name"));
		      $(this.el).html(div);
		      return this;
		  },
		  loadPlaylist: function () {
		      var name = this.model.get("name");
		      $.ajax({
			  type: "delete",
			  url: mpfResource.currentStation,
			  success: function () {
			      mpdAjax("put", "mpd/currentPlaylist", 
				      {name: name}, 
				      function () {
					  currentPlaylist.fetch();
					  $.ajax({
					      type: "post",
					      url: "mpd/play",
					      success: function () {
						  updateStatus();
					      }
					  });
				      });
			  }});
		  }
	      });
	  }

	  {
	      window.Station = Backbone.Model.extend({});

	      var stations = new (Backbone.Collection.extend({
		  model: Station,
		  url: mpfResource.stations,
		  parse: function (response) {
		      return response.stations;
		  }
	      }));

	      window.StationView = Backbone.View.extend({
		  tagName: "div",
		  events: { 
		      "click" : "loadStation"
		  },
		  render: function () {
		      $(this.el).html($("<button>").addClass("station").text(
			  this.model.get("name")));
		      return this;
		  },
		  loadStation: function () {
		      var model = this.model;
		      mpdAjax("post", "mpd/clear", {}, function  () {
			  $.ajax({
			      type: "put",
			      url: mpfResource.currentStation,
			      data: JSON.stringify(model.attributes),
			      success: function () {
				  updateStatus();
			      }
			  });
		      });
		  }
	      });

	      stations.bind("reset", function () {
		  $("#stations").empty();
		  stations.each(function (s) {
		      $("#stations").append(
			  new StationView({model: s}).render().el);
		  });
	      });
	      stations.fetch();
	  }
	  
	  {
	      var playState = new (Backbone.Model.extend({
		  // this is all set by the global /status request
	      }));

	      var playStateView = new (Backbone.View.extend({
		  el: $("#transport"),
		  model: playState,
		  initialize: function () {
		      this.model.bind("change:time", function (ev, pos) {
			  $("#position").text(
			      pos[0] + " of " + pos[1] + " sec");
		      });
		      this.model.bind("change:state", function (ev, state) {
			  $("#pause").text(state == "play" ? "pause" : "play");
		      });
		  },
		  events: {
		      "click #pause" : "click",
		      "click #prevSong" : "prev",
		      "click #nextSong" : "next"
		  },
		  click: function () {
		      $.post("mpd/pause", function () {
			  updateStatus();
		      });
		  },
// if these take you between pandora songs, we need to refresh the contents of the magic pandora item, which is not yet happening (since this is not a playlist version change)
		  prev: function () {
		      $.post("mpd/previous", function () { updateStatus(); });
		  },
		  next: function () {
		      $.post("mpd/next", function () { updateStatus(); });
		  },

	      }));
	  }

	  {
	      window.Song = Backbone.Model.extend({
		  isPandora: function () {
		      return this.get("file").match(
			      /http:\/\/.*?\.pandora\.com\//)
		  }
	      });

	      var nowPlaying = -1;

	      var currentPlaylist = new (Backbone.Collection.extend({
		  model: Song,
		  url: "mpd/playlistinfo",
		  parse: function (response) {
		      $.each(response, function (i, rec) {
			  rec.id = rec.Pos;
		      });
		      return response;
		  },
		  setSong: function (num) {
		      var np = this.get(nowPlaying);
		      if (np) np.set({isPlaying: false});
		      nowPlaying = num;
		      var np = this.get(nowPlaying);
		      if (np) np.set({isPlaying: true});
		  },
		  initialize: function () {
		      this.bind("reset", 
				function () { this.setSong(nowPlaying); }, 
				this);
		  }
	      }));

	      window.SongView = Backbone.View.extend({
		  tagName: "li",
		  events: {
		      "click" : "click"
		  },
		  initialize: function () { 
		      this.model.bind("change:isPlaying", this.setPlaying, 
				      this);
		  },
		  setPlaying: function (_, ip) {
			  if (ip) {
			      $(this.el).addClass("playing");
			  } else {
			      $(this.el).removeClass("playing");
			  }
		  },
		  render: function () { 
		      var div = $("<div>");
		      if (this.model.isPandora()) {
			  div.addClass("currentPandoraSong");
			  updatePandoraCurrentSong();
		      } else {
			  var displayName = (this.model.get("Title") || 
					     this.model.get("file"));
			  div.addClass("song").text(displayName);
		      }
		      $(this.el).html(div);
		      this.setPlaying(null, this.model.get("isPlaying"));
		      return this;
		  },
		  remove: function() {
		      $(this.el).remove();
		  },
		  click: function () {
		      mpdAjax("post", "mpd/play", 
			      {songnum: this.model.get("Pos")},
			      function () {
				  updateStatus();
			      });
		  }
	      });

	      var currentPlaylistView = new (Backbone.View.extend({
		  el: $("#currentPlaylist"),
		  model: currentPlaylist,
		  initialize: function () {
		      this.model.bind('reset', function() {
			  var el = $(this.el);
			  el.empty();
			  this.model.each(function(song) {
			      var view = new SongView({model: song});

			      if (song.isPandora() && $(".currentPandoraSong").length) {
				  // this won't quite be right if there are
				  // pandora songs at various points in your
				  // playlist. you won't see the later ones
				  return;
			      }
			      el.append(view.render().el);
			  });
		      }, this);
		  }
	      }));
	  }

	  window.updateStatus = function(whenDone) {
	      $.getJSON("mpd/status", function (response) {
		  volume.set({volume: response.volume});
		  var p = {state: response.state, 
			   random: response.random};
		  if (response.time) {
		      p.time = response.time.split(":");
		  }
		  playState.set(p);

		  currentPlaylist.setSong(response.song);
		  if (response.playlist != currentPlaylist.version) {
		      currentPlaylist.fetch();
		      // not sure how to get the version of the one i
		      // fetched. this one is close
		      currentPlaylist.version = response.playlist;
		  }
		  if (whenDone) {
		      whenDone();
		  }
	      });
	  }
	  function statusLoop() {
	      updateStatus(function () {
		  // todo: use requestAnimFrame where available
		  setTimeout(statusLoop, 2000);
	      });
	  }
	  statusLoop();
	  //updateStatus();

	  function updatePandoraCurrentSong() {
	      // todo: only relevant if the pandora song is being played now
	      $.getJSON(mpfResource.currentSong, function (data) {
		  var p = data.song.pandora;
		  if (p) {
		      $(".currentPandoraSong").text(
			  p.title + " / " + p.artist + " / " + p.album);
		  } else {
		      $(".currentPandoraSong").text("(songs from Pandora)");
		  }
	      });
	  }

	  $.getJSON("mpd", function (data) {
	      $("#mpdWebConfig").text(
		  "mpdweb running on "+data.host+" talking to mpd at "+
		      data.mpd.host+":"+data.mpd.port);
	  });
	  $.getJSON(mpfResource.root, function (data) {
	      $("#mpdPandoraFeederConfig").text(
		  "mpdpandorafeeder running on "+data.host+
		      " talking to mpd at "+data.mpd.host+":"+data.mpd.port);
	  });

      function Search(inputElem, resultElem) {

	  updateSearch();
	  inputElem.bind("keyup", updateSearch);

     	  function albumRow(row) {
	      var albumPath = albumFromSongFile(row.file)
  	      var form = $("<form>").ajaxForm(closeSearch).attr(
		  {method: "POST", 
		   action: "addAndPlay/"+escape(albumPath)})
		  .append($("<button>").text("Play"))
		  .append($("<span>").text(
		      "Album "+row.Album+ " " + row.Artist));
	      
   	      return $("<li>").append(form);
	  }

	  function songRow(row) {
	      return $("<li>").append(
		  $("<form>").ajaxForm(closeSearch).attr(
		      {method: "POST",
		       action: "addAndPlay/"+escape(row.file)})
		      .append($("<button>").text("Play"))
		      .append($("<span>").text(
			  row.Track + " " + row.Title)));
	  }

  	  function updateSearch() {
	      resultElem.show();

	      var ol = resultElem.find("ol");

	      var q = strip(inputElem.val());
	      if (q.length < 3) {
		  ol.text("Enter search");
		  return;
	      }

	      ol.empty().text("Searching...");
	      var albumsShown = 0;
	      $.getJSON(
		  "mpd/search", {type: "album", query: q}, 
		  function (data) {
		      ol.empty();

		      var lastAlbum = null;
		      var currentSection = null;
		      $.each(data, function (i, row) {
			  if (albumsShown > 5) {
			      return;
			  }
			  if (lastAlbum === null || row.Album != lastAlbum) {
			      ol.append(albumRow(row));
			      albumsShown += 1;
			      currentSection = $("<ul>");
			      ol.append(currentSection);
			      lastAlbum = row.Album;
			  }
			  currentSection.append(songRow(row));
		      });
		      if (albumsShown == 0) {
			  ol.text("No matches");
		      }
		  });
	  }

	  function closeSearch() {
	      inputElem.val("");
	      resultElem.hide();
	  }
      }

      new Search($("input[name=q]"), $(".search > .results"));
	
     });
// ]]>
  </script>
    
  </head>
  <body>

    <div class="section configs">
      <div id="mpdWebConfig"></div>
      <div id="mpdPandoraFeederConfig"></div>
    </div>

    <div class="section search">
      Search: <input type="text" name="q" value="incep" autocomplete="off"/>
      <div class="results" style="display: none">
        <h2>Results:</h2>

        <ol>         
        </ol>
      </div>
    </div>

    <div id="transport" class="section transport">
      <div><span id="position"></span></div>
      <div><button id="prevSong">&lt; prev</button><button id="nextSong">next &gt;</button></div>
      <div><button id="pause">Pause</button></div>
    </div>

    <div class="section loadPlaylistArea">
      <h2>Load playlist:</h2>
      <div id="playlists"></div>
    </div>
    
    <div class="section loadStationArea">
      <h2>Play station:</h2>
      <div id="stations"></div>
    </div>
<div style="clear: both"/>
    <div class="section volumeStack">
      <h2>Volume</h2>
      <div><button>100</button></div>
      <div><button>80</button></div>
      <div><button>60</button></div>
      <div><button>40</button></div>
      <div><button>20</button></div>
      <div><button>0</button></div>

      <div class="local upper"><button>83</button></div>
      <div class="local current">81</div>
      <div class="local lower"><button>79</button></div>
    </div>

    <div class="section currentPlaylistArea">
      <h2>Current playlist</h2>
      <div id="currentPlaylist"></div>
    </div>

  </body>
</html>
